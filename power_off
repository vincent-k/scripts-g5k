#!/bin/bash

# Get parameter
NODE="$1"

# Get variables from config file
. ./config


function wait_for_halt {

        local NODE="$1"

	# Check if the chassis status is off
	while [ `ipmitool -H $(host $(echo "$NODE" | cut -d'.' -f1)-bmc | awk '{print $4;}') -I lan -U $BMC_USER -P $BMC_MDP chassis status | grep System | grep on | wc -l` -gt 0 ]; do
		sleep 2
	done
}

if [ -n "$NODE" ]; then

	local START=$(date +%s)

	if [ -f "$NODE" ]; then
		echo -ne "Powering off $((cat $NODE | wc -l)) nodes .."
		kapower3 --off -f $NODE >/dev/null

		# Wait for shutdown of all nodes
		for N in `cat $NODE`; do
			wait_for_halt $N &
		done
		wait

		local END=$(date +%s)

		echo -e ". done. (total shutdown time = $(($END - $START)))s"
	else
		echo -ne "Powering off node '$NODE' .."
		kapower3 --off -m $NODE >/dev/null

		# Wait for shutdow
		wait_for_halt $NODE

		local END=$(date +%s)

		echo -e ". done. (shutdown time = $(($END - $START)))s"
	fi	
fi
